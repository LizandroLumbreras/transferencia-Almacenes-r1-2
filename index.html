<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Traspaso entre Almacenes</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---------------- FIREBASE CONFIG ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",  // ‚úÖ corregido
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------------- VARIABLES ----------------
    let carrito = [];
    let resultadosBusqueda = [];
    let paginaActual = 0;
    const porPagina = 10;

    // ---------------- TELEGRAM CONFIG ----------------
    const BOT_TOKEN = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
    const CHAT_ID   = "6617988297";

    // ---------------- IndexedDB ----------------
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("provsoftDB", 1);
        request.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains("productos")) {
            db.createObjectStore("productos", { keyPath: "codigoBarra" });
          }
        };
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e);
      });
    }

    async function saveProductos(lista) {
      const db = await openDB();
      const tx = db.transaction("productos", "readwrite");
      const store = tx.objectStore("productos");
      lista.forEach(p => store.put(p));
      return tx.done || new Promise(resolve => tx.oncomplete = resolve);
    }

    async function getAllProductos() {
      const db = await openDB();
      return new Promise(resolve => {
        const tx = db.transaction("productos", "readonly");
        const store = tx.objectStore("productos");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
      });
    }

    // ---------------- SINCRONIZACI√ìN INCREMENTAL ----------------
    async function syncProductos() {
      try {
        const ultimaSync = localStorage.getItem("ultimaSync") || "2000-01-01T00:00:00.000Z";
        console.log("‚è± √öltima sincronizaci√≥n:", ultimaSync);

        const q = query(
          collection(db, "productos"),
          where("activo", "==", true),
          where("updatedAt", ">", ultimaSync)
        );

        const snap = await getDocs(q);

        if (!snap.empty) {
          const lista = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          await saveProductos(lista);
          localStorage.setItem("ultimaSync", new Date().toISOString());
          console.log(`‚úÖ Cat√°logo actualizado (${lista.length} productos nuevos/actualizados)`);
        } else {
          console.log("‚úÖ No hay cambios desde la √∫ltima sincronizaci√≥n");
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è Error al sincronizar:", err.message);
      }
    }

    // ---------------- B√öSQUEDAS ----------------
    async function buscarPorNombre() {
      const termino = document.getElementById("busquedaNombre").value.trim().toLowerCase();
      if (!termino) {
        document.getElementById("listaResultados").innerHTML = "";
        return;
      }

      const productos = await getAllProductos();
      resultadosBusqueda = productos.filter(p =>
        p.concepto && p.concepto.toLowerCase().includes(termino)
      );

      paginaActual = 0;
      mostrarPagina();
      document.getElementById("modalResultados").style.display = "block";
    }

    function mostrarPagina() {
      const lista = document.getElementById("listaResultados");
      lista.innerHTML = "";
      const inicio = paginaActual * porPagina;
      const fin = inicio + porPagina;
      const pagina = resultadosBusqueda.slice(inicio, fin);

      pagina.forEach(data => {
        const item = document.createElement("div");
        item.className = "item";
        item.innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;
        item.onclick = () => {
          seleccionarProducto(data);
          cerrarModal();
        };
        lista.appendChild(item);
      });

      document.getElementById("paginacion").innerText =
        `P√°gina ${paginaActual+1} de ${Math.ceil(resultadosBusqueda.length/porPagina)}`;
    }

    function siguientePagina() {
      if ((paginaActual+1) * porPagina < resultadosBusqueda.length) {
        paginaActual++;
        mostrarPagina();
      }
    }
    function anteriorPagina() {
      if (paginaActual > 0) {
        paginaActual--;
        mostrarPagina();
      }
    }

    // ---------------- PRODUCTO ----------------
    async function buscarPorCodigo() {
      const codigo = document.getElementById("buscador").value.trim();
      if (!codigo) return;

      console.log("üîé Buscando c√≥digo:", codigo);
      const productos = await getAllProductos();
      const encontrado = productos.find(p => p.codigoBarra === codigo);

      if (encontrado) {
        console.log("‚úÖ Producto encontrado:", encontrado);
        seleccionarProducto(encontrado);
      } else {
        console.log("‚ùå C√≥digo no encontrado en cat√°logo");
        document.getElementById("preview").innerText = "‚ùå No encontrado";
        document.getElementById("codigoSel").value = "";
        document.getElementById("conceptoSel").value = "";
        document.getElementById("precioSel").value = "";
      }

      document.getElementById("buscador").value = "";
    }

    function seleccionarProducto(data) {
      document.getElementById("codigoSel").value = data.codigoBarra;
      document.getElementById("conceptoSel").value = data.concepto;
      document.getElementById("precioSel").value = data.precioPublico;
      document.getElementById("preview").innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;

      const cantidadInput = document.getElementById("cantidad");
      cantidadInput.focus();
      cantidadInput.select();
    }

    function agregarItem() {
      const codigo = document.getElementById("codigoSel").value;
      const concepto = document.getElementById("conceptoSel").value;
      const precio = parseFloat(document.getElementById("precioSel").value);
      let cantidad = parseInt(document.getElementById("cantidad").value);

      if (!codigo) return;
      if (!cantidad || cantidad < 1) cantidad = 1;

      carrito.push({ codigo, concepto, precio, cantidad });
      renderTabla();

      document.getElementById("cantidad").value = "1";
      document.getElementById("preview").innerText = "";
      document.getElementById("codigoSel").value = "";
      document.getElementById("conceptoSel").value = "";
      document.getElementById("precioSel").value = "";
      document.getElementById("buscador").focus();
    }

    function renderTabla() {
      const tabla = document.getElementById("tabla");
      tabla.innerHTML = "";
      carrito.forEach((item, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.codigo}</td>
          <td>${item.concepto}</td>
          <td>${item.cantidad}</td>
          <td>$${item.precio}</td>
          <td><button onclick="eliminarItem(${i})">‚ùå</button></td>
        `;
        tabla.appendChild(row);
      });
    }

    function eliminarItem(index) {
      carrito.splice(index, 1);
      renderTabla();
    }

    // ---------------- FINALIZAR TRASPASO ----------------
    async function finalizarTraspaso() {
      const ruta = document.getElementById("ruta").value;
      const vendedor = document.getElementById("vendedor").value;
      if (carrito.length === 0 || !ruta) { 
        alert("Faltan datos"); 
        return; 
      }

      const folio = generarFolio(ruta);

      await addDoc(collection(db, `almacenes/${ruta}/entradas`), { folio, vendedor, items: carrito });
      await addDoc(collection(db, `almacenes/ALMACENCENTRALPDD/salidas`), { folio, vendedor, items: carrito });

      await enviarTelegram(folio, ruta, vendedor, carrito);

      abrirComprobante(folio, ruta, vendedor, carrito);

      carrito = [];
      renderTabla();
    }

    function generarFolio(ruta) {
      const hoy = new Date();
      const dd = String(hoy.getDate()).padStart(2, "0");
      const mm = String(hoy.getMonth() + 1).padStart(2, "0");
      const yy = String(hoy.getFullYear()).slice(-2);
      const fecha = `${dd}${mm}${yy}`;
      const consecutivo = String(Math.floor(Math.random() * 999)).padStart(3, "0");
      return `${ruta}-${fecha}-${consecutivo}`;
    }

    function dividirEnBloques(array, size) {
      const bloques = [];
      for (let i = 0; i < array.length; i += size) {
        bloques.push(array.slice(i, i + size));
      }
      return bloques;
    }

    async function enviarTelegram(folio, destino, vendedor, items) {
      const total = items.length;
      const bloques = dividirEnBloques(items, 20);

      for (let i = 0; i < bloques.length; i++) {
        let mensaje = `üì¶ *Nuevo Traspaso*\n`;
        if (i === 0){ 
          mensaje += `Folio: ${folio}\nDestino: ${destino}\nVendedor: ${vendedor}\nTotal de productos: ${total}\n`;
        }
        mensaje += `üìã *Bloque ${i+1}/${bloques.length}:*\n`;
        bloques[i].forEach(it=>{
          mensaje += `- ${it.cantidad} x ${it.concepto}\n`;
        });

        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: CHAT_ID, text: mensaje, parse_mode: "Markdown" })
        });
      }
    }

    function abrirComprobante(folio, ruta, vendedor, items) {
      const fecha = new Date().toLocaleDateString();
      let tabla = "";
      items.forEach(it=>{
        tabla += `<tr><td>${it.codigo}</td><td>${it.concepto}</td><td>${it.cantidad}</td><td>$${it.precio}</td></tr>`;
      });

      const win = window.open("", "_blank");
      win.document.write(`
        <html><head><title>Comprobante ${folio}</title>
        <style>
          body{font-family:Arial;margin:20px;}
          h1{text-align:center;color:#003366;}
          .folio{font-size:24px;font-weight:bold;color:#b30000;text-align:center;border:2px dashed #b30000;margin:10px;padding:5px;}
          table{width:100%;border-collapse:collapse;margin-top:15px;}
          th,td{border:1px solid #ccc;padding:6px;}
          th{background:#eee;}
          .firmas{margin-top:40px;display:flex;justify-content:space-between;}
          .firma{width:45%;text-align:center;}
          .linea{margin-top:60px;border-top:1px solid #000;}
        </style></head><body>
        <h1>üì¶ PROVEEDORA DE DULCES Y DESECHABLES</h1>
        <h2 style="text-align:center">Comprobante de Traspaso</h2>
        <div class="folio">Folio: ${folio}</div>
        <p><b>Fecha:</b> ${fecha}<br><b>Destino:</b> ${ruta}<br><b>Vendedor:</b> ${vendedor}<br><b>Total:</b> ${items.length}</p>
        <table><thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th></tr></thead><tbody>
        ${tabla}
        </tbody></table>
        <div class="firmas">
          <div class="firma"><div class="linea"></div>Entreg√≥ (Administrador)</div>
          <div class="firma"><div class="linea"></div>Recibi√≥ (Vendedor)</div>
        </div>
        <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </body></html>
      `);
      win.document.close();
    }

    async function cargarVendedor() {
      const ruta = document.getElementById("ruta").value;
      console.log("üîé Buscando vendedor para ruta:", ruta);
      if (!ruta) return;

      const q = query(
        collection(db,"usuarios_ruta"),
        where("rutaId","==",ruta),
        where("activo","==",true)
      );

      const snap = await getDocs(q);

      if (!snap.empty){
        snap.forEach(doc=>{
          const data = doc.data();
          console.log("‚úÖ Vendedor encontrado:", data);
          document.getElementById("vendedor").value = data.nombre;
        });
      } else {
        console.warn("‚ö†Ô∏è No se encontr√≥ vendedor para:", ruta);
        document.getElementById("vendedor").value = "No asignado";
      }
    }

    function cerrarModal(){
      document.getElementById("modalResultados").style.display = "none";
    }

    // ---------------- INIT ----------------
    document.addEventListener("DOMContentLoaded", async ()=>{
      await syncProductos();

      document.getElementById("ruta").addEventListener("change", cargarVendedor);
      document.getElementById("btnBuscarNombre").addEventListener("click", buscarPorNombre);
      document.getElementById("btnBuscarCodigo").addEventListener("click", buscarPorCodigo);
      document.getElementById("cerrarModal").addEventListener("click", cerrarModal);
      document.getElementById("btnAnterior").addEventListener("click", anteriorPagina);
      document.getElementById("btnSiguiente").addEventListener("click", siguientePagina);
      document.getElementById("btnTraspaso").addEventListener("click", finalizarTraspaso);

      document.getElementById("buscador").addEventListener("keypress",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); buscarPorCodigo(); }
      });

      document.getElementById("cantidad").addEventListener("keypress",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); agregarItem(); }
      });

      // ‚úÖ mover focus al final y protegido
      const buscador = document.getElementById("buscador");
      if (buscador) buscador.focus();
    });

    window.agregarItem = agregarItem;
    window.eliminarItem = eliminarItem;
  </script>
