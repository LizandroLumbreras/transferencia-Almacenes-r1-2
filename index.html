<!DOCTYPE html>
<html lang="es">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<head>
  <meta charset="UTF-8">
  <title>Traspaso entre Almacenes</title>
  <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, query, where, getDocs, addDoc, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---------------- FIREBASE CONFIG ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------------- VARIABLES ----------------
    let carrito = [];
    let resultadosBusqueda = [];
    let paginaActual = 0;
    const porPagina = 10;

    // ---------------- TELEGRAM CONFIG ----------------
    const BOT_TOKEN = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
    const CHAT_ID   = "6617988297";

    // ---------------- IndexedDB ----------------
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("provsoftDB", 1);
        request.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains("productos")) {
            db.createObjectStore("productos", { keyPath: "codigoBarra" });
          }
        };
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e);
      });
    }

    async function saveProductos(lista) {
      const dbi = await openDB();
      const tx = dbi.transaction("productos", "readwrite");
      const store = tx.objectStore("productos");
      lista.forEach(p => store.put(p));
      return tx.done || new Promise(resolve => tx.oncomplete = resolve);
    }

    async function getAllProductos() {
      const dbi = await openDB();
      return new Promise(resolve => {
        const tx = dbi.transaction("productos", "readonly");
        const store = tx.objectStore("productos");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
      });
    }

    // ---------------- SINCRONIZACI√ìN INCREMENTAL ----------------
    async function syncProductos() {
      try {
        const ultimaSyncStr = localStorage.getItem("ultimaSync") || "2000-01-01T00:00:00.000Z";
        const ultimaSyncTs = Timestamp.fromDate(new Date(ultimaSyncStr));
const q = query(
  collection(db, "productos"),
  where("activo", "==", true),
  where("updatedAt", ">", ultimaSyncTs)
);
  const snap = await getDocs(q);  // üëà usar 'q'

        if (!snap.empty) {
          const lista = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          await saveProductos(lista);
          localStorage.setItem("ultimaSync", new Date().toISOString());
          console.log(`‚úÖ Cat√°logo actualizado (${lista.length} productos nuevos/actualizados)`);
        } else {
          console.log("‚úÖ No hay cambios desde la √∫ltima sincronizaci√≥n");
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è Error al sincronizar:", err.message);
      }
    }

    // ---------------- B√öSQUEDAS ----------------
    async function buscarPorNombre() {
      const termino = document.getElementById("busquedaNombre").value.trim().toLowerCase();
      if (!termino) {
        document.getElementById("listaResultados").innerHTML = "";
        return;
      }

      const productos = await getAllProductos();
      resultadosBusqueda = productos.filter(p =>
        p.concepto && p.concepto.toLowerCase().includes(termino)
      );

      paginaActual = 0;
      mostrarPagina();
      document.getElementById("modalResultados").style.display = "block";
    }

    function mostrarPagina() {
      const lista = document.getElementById("listaResultados");
      lista.innerHTML = "";
      const inicio = paginaActual * porPagina;
      const fin = inicio + porPagina;
      const pagina = resultadosBusqueda.slice(inicio, fin);

      pagina.forEach(data => {
        const item = document.createElement("div");
        item.className = "item";
        item.innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;
        item.onclick = () => {
          seleccionarProducto(data);
          cerrarModal();
        };
        lista.appendChild(item);
      });

      const totalPags = Math.max(1, Math.ceil(resultadosBusqueda.length / porPagina));
      document.getElementById("paginacion").innerText = `P√°gina ${paginaActual + 1} de ${totalPags}`;
    }

    function siguientePagina() {
      if ((paginaActual + 1) * porPagina < resultadosBusqueda.length) {
        paginaActual++;
        mostrarPagina();
      }
    }
    function anteriorPagina() {
      if (paginaActual > 0) {
        paginaActual--;
        mostrarPagina();
      }
    }
// ---------------- EQUIVALENCIAS ----------------
async function buscarEnEquivalencias(codigoInput) {
  const codigoStr = String(codigoInput).trim();
  const q = query(
    collection(db, "productos"),
    where("codigosEquivalentes", "array-contains", codigoStr)
  );
  const snap = await getDocs(q);
  if (!snap.empty) {
    const docu = snap.docs[0];
    return { id: docu.id, ...docu.data() };
  }
  return null;
}

    // ---------------- PRODUCTO ----------------
async function buscarPorCodigo() {
  const codigo = document.getElementById("buscador").value.trim();
  if (!codigo) return;

  console.log("üîé Buscando c√≥digo:", codigo);

  // 1. Buscar en cache (IndexedDB)
  const productos = await getAllProductos();
  let encontrado = productos.find(p => String(p.codigoBarra) === String(codigo));

  // 2. Si no est√° en cache, buscar en Firestore por codigoBarra
  if (!encontrado) {
    console.log("‚ö†Ô∏è No est√° en cache, buscando en Firestore...");
    const qProd = query(
      collection(db, "productos"),
      where("codigoBarra", "==", codigo),
      where("activo", "==", true)
    );
    const snap = await getDocs(qProd);
    if (!snap.empty) {
      encontrado = { id: snap.docs[0].id, ...snap.docs[0].data() };
      await saveProductos([encontrado]); // lo guardo en cache
    }
  }

  // 3. Si tampoco se encontr√≥, buscar en equivalentes
  if (!encontrado) {
    console.log("üîÑ Buscando en equivalentes...");
    encontrado = await buscarEnEquivalencias(codigo);
    if (encontrado) {
      await saveProductos([encontrado]);
    }
  }

  // 4. Mostrar resultado
  if (encontrado) {
    console.log("‚úÖ Producto encontrado:", encontrado);
    seleccionarProducto(encontrado);
  } else {
    console.log("‚ùå C√≥digo no encontrado en Firestore ni en cache");
    document.getElementById("preview").innerText = "‚ùå No encontrado";
    document.getElementById("codigoSel").value = "";
    document.getElementById("conceptoSel").value = "";
    document.getElementById("precioSel").value = "";
  }

  document.getElementById("buscador").value = "";
}

    function seleccionarProducto(data) {
      document.getElementById("codigoSel").value = data.codigoBarra;
      document.getElementById("conceptoSel").value = data.concepto || "";
      document.getElementById("precioSel").value = data.precioPublico ?? 0;
      document.getElementById("preview").innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;

      const cantidadInput = document.getElementById("cantidad");
      cantidadInput.focus();
      cantidadInput.select();
    }

    function agregarItem() {
      const codigo = document.getElementById("codigoSel").value;
      const concepto = document.getElementById("conceptoSel").value;
      const precio = parseFloat(document.getElementById("precioSel").value || "0");
      let cantidad = parseInt(document.getElementById("cantidad").value || "1", 10);

      if (!codigo) return;
      if (!cantidad || cantidad < 1) cantidad = 1;

      carrito.push({ codigo, concepto, precio, cantidad });
      renderTabla();

      document.getElementById("cantidad").value = "1";
      document.getElementById("preview").innerText = "";
      document.getElementById("codigoSel").value = "";
      document.getElementById("conceptoSel").value = "";
      document.getElementById("precioSel").value = "";
      document.getElementById("buscador").focus();
    }

    function renderTabla() {
      const tabla = document.getElementById("tabla");
      tabla.innerHTML = "";
      carrito.forEach((item, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.codigo}</td>
          <td>${item.concepto}</td>
          <td>${item.cantidad}</td>
          <td>$${item.precio}</td>
          <td><button onclick="eliminarItem(${i})">‚ùå</button></td>
        `;
        tabla.appendChild(row);
      });
    }

    function eliminarItem(index) {
      carrito.splice(index, 1);
      renderTabla();
    }

    // ---------------- FINALIZAR TRASPASO ----------------
    async function finalizarTraspaso() {
      const ruta = document.getElementById("ruta").value;
      const vendedor = document.getElementById("vendedor").value || "No asignado";
      if (carrito.length === 0 || !ruta) {
        alert("Faltan datos");
        return;
      }

      const folio = generarFolio(ruta);

      // Guardar en Firestore
      await addDoc(collection(db, `almacenes/${ruta}/entradas`), { folio, vendedor, items: carrito, createdAt: Timestamp.now() });
      await addDoc(collection(db, `almacenes/ALMACENCENTRALPDD/salidas`), { folio, vendedor, items: carrito, createdAt: Timestamp.now() });

      // Enviar a Telegram
      await enviarTelegram(folio, ruta, vendedor, carrito);

      // Abrir comprobante imprimible
      abrirComprobante(folio, ruta, vendedor, carrito);

      carrito = [];
      renderTabla();
    }

    function generarFolio(ruta) {
      const hoy = new Date();
      const dd = String(hoy.getDate()).padStart(2, "0");
      const mm = String(hoy.getMonth() + 1).padStart(2, "0");
      const yy = String(hoy.getFullYear()).slice(-2);
      const fecha = `${dd}${mm}${yy}`;
      const consecutivo = String(Math.floor(Math.random() * 999)).padStart(3, "0");
      return `${ruta}-${fecha}-${consecutivo}`;
    }

    function dividirEnBloques(array, size) {
      const bloques = [];
      for (let i = 0; i < array.length; i += size) {
        bloques.push(array.slice(i, i + size));
      }
      return bloques;
    }

    async function enviarTelegram(folio, destino, vendedor, items) {
      const total = items.length;
      const bloques = dividirEnBloques(items, 20);

      for (let i = 0; i < bloques.length; i++) {
        let mensaje = `üì¶ *Nuevo Traspaso*\n`;
        if (i === 0){
          mensaje += `Folio: ${folio}\nDestino: ${destino}\nVendedor: ${vendedor}\nTotal de productos: ${total}\n`;
        }
        mensaje += `üìã *Bloque ${i+1}/${bloques.length}:*\n`;
        bloques[i].forEach(it=>{
          mensaje += `- ${it.cantidad} x ${it.concepto}\n`;
        });

        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: CHAT_ID, text: mensaje, parse_mode: "Markdown" })
        });
      }
    }

    function abrirComprobante(folio, ruta, vendedor, items) {
      const fecha = new Date().toLocaleDateString();
      let tabla = "";
      items.forEach(it=>{
        tabla += `<tr><td>${it.codigo}</td><td>${it.concepto}</td><td>${it.cantidad}</td><td>$${it.precio}</td></tr>`;
      });

      const win = window.open("", "_blank");
      win.document.write(`
        <html><head><title>Comprobante ${folio}</title>
        <style>
         body{
  font-family:'Poppins',sans-serif;
  margin:0;
  background:var(--bg-grad);
  min-height:100vh;
  color:white;
}
          h1{text-align:center;color:#003366;}
          .folio{font-size:24px;font-weight:bold;color:#b30000;text-align:center;border:2px dashed #b30000;margin:10px;padding:5px;}
          table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  min-width:760px;
}
th,td{
  padding:10px;
  border:1px solid #ccc;
  text-align:center;
}
th{
  background-color:var(--azul);
  color:white;
  position:sticky;
  top:0;
}

          .firmas{margin-top:40px;display:flex;justify-content:space-between;}
          .firma{width:45%;text-align:center;}
          .linea{margin-top:60px;border-top:1px solid #000;}
        </style></head><body>
        <h1>üì¶ PROVEEDORA DE DULCES Y DESECHABLES</h1>
        <h2 style="text-align:center">Comprobante de Traspaso</h2>
        <div class="folio">Folio: ${folio}</div>
        <p><b>Fecha:</b> ${fecha}<br><b>Destino:</b> ${ruta}<br><b>Vendedor:</b> ${vendedor}<br><b>Total:</b> ${items.length}</p>
        <table><thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th></tr></thead><tbody>
        ${tabla}
        </tbody></table>
        <div class="firmas">
          <div class="firma"><div class="linea"></div>Entreg√≥ (Administrador)</div>
          <div class="firma"><div class="linea"></div>Recibi√≥ (Vendedor)</div>
        </div>
        <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <div class="wm-logo"><img src="logo-proveedora.webp" alt=""></div>
        </body></html>
      `);
      win.document.close();
    }

    // ---------------- RUTA -> VENDEDOR ----------------
    async function cargarVendedor() {
      const ruta = document.getElementById("ruta").value;
      console.log("üîé Buscando vendedor para ruta:", ruta);
      if (!ruta) return;

      const qUsr = query(
        collection(db,"usuarios_ruta"),
        where("rutaId","==",ruta),
        where("activo","==",true)
      );

      const snap = await getDocs(qUsr);

      if (!snap.empty){
        // si hay varios, uso el primero
        const data = snap.docs[0].data();
        console.log("‚úÖ Vendedor encontrado:", data);
        document.getElementById("vendedor").value = data.nombre || "No asignado";
      } else {
        console.warn("‚ö†Ô∏è No se encontr√≥ vendedor para:", ruta);
        document.getElementById("vendedor").value = "No asignado";
      }
    }

    function cerrarModal(){
      document.getElementById("modalResultados").style.display = "none";
    }

    // ---------------- INIT ----------------
    document.addEventListener("DOMContentLoaded", async ()=>{
      await syncProductos();
      document.getElementById("buscador").focus();

      // Listeners (ya con DOM cargado)
      document.getElementById("ruta").addEventListener("change", cargarVendedor);
      document.getElementById("btnBuscarNombre").addEventListener("click", ()=>{
        document.getElementById("modalResultados").style.display = "block";
        document.getElementById("busquedaNombre").focus();
      });
      document.getElementById("btnBuscarCodigo").addEventListener("click", buscarPorCodigo);
      document.getElementById("cerrarModal").addEventListener("click", cerrarModal);
      document.getElementById("btnAnterior").addEventListener("click", anteriorPagina);
      document.getElementById("btnSiguiente").addEventListener("click", siguientePagina);
      document.getElementById("btnTraspaso").addEventListener("click", finalizarTraspaso);
      document.getElementById("busquedaNombre").addEventListener("input", buscarPorNombre);
      document.getElementById("btnAgregar").addEventListener("click", agregarItem);
      // y si quieres exponer por si alg√∫n html legacy lo llama:
      window.agregarItem = agregarItem;


      // Enter en buscador de c√≥digo
      document.getElementById("buscador").addEventListener("keypress",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); buscarPorCodigo(); }
      });

      // Enter en cantidad para agregar item
      document.getElementById("cantidad").addEventListener("keypress",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); agregarItem(); }
      });

      // Exponer funciones para botones inline
      window.agregarItem  = agregarItem;
      window.eliminarItem = eliminarItem;
    });
  </script>

  <style>
:root {
  --azul:#00416A;
  --resalte:#0c6cbd;
  --ok:#1e8e3e;
  --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
  --card: rgba(255,255,255,.85);   /* üëà m√°s transparencia */
  --muted:rgba(0,0,0,.55);
  --shadow:0 6px 18px rgba(0,0,0,.18);
  --radius:14px;
}

body {
  font-family:'Poppins',sans-serif;
  margin:0;
  background:var(--bg-grad);
  min-height:100vh;
  color:white;
}

.panel {
  max-width:900px;
  margin:30px auto;
  background:var(--card);
  backdrop-filter: blur(8px);   /* üëà difumina logo debajo */
  color:#222;
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  position:relative;
  z-index:1;
}

h2 {
  color: var(--azul);
  margin-top:0;
}

label { display:block; margin-top:10px; font-weight:600; }
input,select { padding:8px; border:1px solid #ccc; border-radius:6px; }
#buscador { width:70%; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td {
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
}
th {
  background: var(--azul);
  color:white;
}

button {
  margin-top:10px;
  padding:10px 16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.boton, .btn {
  background:var(--resalte);
  color:white;
  font-weight:600;
  padding:10px 16px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  transition:background .3s;
}
.boton:hover, .btn:hover { background:#084f92; }

.modal {
  display:none; position:fixed; z-index:1000;
  left:0; top:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5);
}
.modal-content {
  background:#fff;
  margin:5% auto;
  padding:20px;
  border-radius:10px;
  width:80%; max-width:600px; max-height:70%;
  overflow-y:auto;
}
.close { float:right; font-size:28px; cursor:pointer; }
#listaResultados .item { padding:8px; border-bottom:1px solid #eee; cursor:pointer; }
#listaResultados .item:hover { background:#f0f0f0; }
.footer { text-align:center; margin-top:20px; font-size:14px; color:#eee; }

.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px 30px; }
.buscador-group,.cantidad-group { display:flex; gap:8px; align-items:center; }
.buscador-group input { flex:1; }
.cantidad-group input { width:80px; }

.wm-logo {
  position:fixed; inset:0; z-index:0; pointer-events:none;
}
.wm-logo img {
  position:absolute; top:50%; left:50%;
  transform: translate(-50%, -50%) rotate(0deg);
  width: clamp(600px,80vmin,1400px);
  opacity:.12;                   /* üëà transparencia */
  mix-blend-mode: normal;
  filter: grayscale(20%) saturate(120%) contrast(105%);
}

  </style>
</head>
<body>
  <div class="panel">
    <h2>‚¨áÔ∏è Traspaso a Vendedores</h2>

    <div class="form-grid">
      <div>
        <label>Ruta destino:</label>
        <select id="ruta">
          <option value="">-- Seleccionar --</option>
          <option value="Almacen_Ruta_1">Ruta 1</option>
          <option value="Almacen_Ruta_2">Ruta 2</option>
        </select>
      </div>

      <div>
        <label>Vendedor:</label>
        <input type="text" id="vendedor" readonly />
      </div>

      <div>
        <label>Captura producto:</label>
        <div class="buscador-group">
          <input type="text" id="buscador" placeholder="Escanea c√≥digo de barras..." />
          <button id="btnBuscarCodigo">‚úîÔ∏è Capturar</button>
          <button id="btnBuscarNombre">üîç Buscar</button>
        </div>

        <div id="preview" style="margin:10px 0;font-weight:bold;color:#003366;"></div>
        <input type="hidden" id="codigoSel">
        <input type="hidden" id="conceptoSel">
        <input type="hidden" id="precioSel">
      </div>

      <div>
        <label>Cantidad:</label>
        <div class="cantidad-group">
          <input type="number" id="cantidad" value="1" min="1"/>
          <button class="btn" id="btnAgregar">‚ûï Agregar a Lista</button>
        </div>
      </div>
    </div>

    <table>
      <thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th><th></th></tr></thead>
      <tbody id="tabla"></tbody>
    </table>
    <button class="btn" id="btnTraspaso">üì§ Finalizar Traspaso</button>
  </div>

  <!-- Modal resultados -->
  <div id="modalResultados" class="modal">
    <div class="modal-content">
      <span id="cerrarModal" class="close">&times;</span>
      <h3>Resultados de b√∫squeda</h3>
      <input type="text" id="busquedaNombre" placeholder="Escribe nombre..." style="width:100%;margin-bottom:10px;">
      <div id="listaResultados"></div>
      <div style="margin-top:10px;text-align:center;">
        <button id="btnAnterior">‚¨ÖÔ∏è Anterior</button>
        <span id="paginacion"></span>
        <button id="btnSiguiente">Siguiente ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <div class="footer">Powered by <b>PROVSOFT</b></div>
  <div class="wm-logo">
  <img src="logo-proveedora.webp" alt="Logo Proveedora">
</div>
</body>
</html>
