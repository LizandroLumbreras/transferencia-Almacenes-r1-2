<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Traspaso entre Almacenes</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, addDoc, Timestamp }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ---------------- FIREBASE CONFIG ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------------- VARIABLES ----------------
  let carrito = [];
  let resultadosBusqueda = [];
  let paginaActual = 0;
  const porPagina = 10;

  // ---------------- TELEGRAM CONFIG ----------------
  const BOT_TOKEN = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
  const CHAT_ID   = "6617988297";

  // ---------------- IndexedDB ----------------
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open("provsoftDB", 1);
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("productos")) {
          db.createObjectStore("productos", { keyPath: "codigoBarra" });
        }
      };
      request.onsuccess = e => resolve(e.target.result);
      request.onerror = e => reject(e);
    });
  }

  async function saveProductos(lista) {
    const dbi = await openDB();
    const tx = dbi.transaction("productos", "readwrite");
    const store = tx.objectStore("productos");
    lista.forEach(p => store.put(p));
    return new Promise(resolve => tx.oncomplete = resolve);
  }

  async function getAllProductos() {
    const dbi = await openDB();
    return new Promise(resolve => {
      const tx = dbi.transaction("productos", "readonly");
      const store = tx.objectStore("productos");
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result || []);
    });
  }

  // ---------------- SINCRONIZACI√ìN ----------------
  async function syncProductos() {
    try {
      const q = query(collection(db, "productos"), where("activo", "==", true));
      const snap = await getDocs(q);

      if (!snap.empty) {
        const lista = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        await saveProductos(lista);
        console.log(`‚úÖ Cat√°logo sincronizado (${lista.length} productos)`);
      } else {
        console.log("‚ö†Ô∏è No se encontraron productos activos en Firestore");
      }
    } catch (err) {
      console.error("‚ùå Error al sincronizar:", err);
    }
  }

  // ---------------- B√öSQUEDA POR NOMBRE ----------------
  async function buscarPorNombre() {
    const termino = document.getElementById("busquedaNombre").value.trim().toLowerCase();
    const productos = await getAllProductos();

    resultadosBusqueda = productos.filter(p => {
      const texto = (p.concepto || p.descripcion || "").toLowerCase();
      return texto.includes(termino);
    });

    paginaActual = 0;
    mostrarPagina();
  }

  function mostrarPagina() {
    const lista = document.getElementById("listaResultados");
    lista.innerHTML = "";
    const inicio = paginaActual * porPagina;
    const fin = inicio + porPagina;
    const pagina = resultadosBusqueda.slice(inicio, fin);

    pagina.forEach(data => {
      const item = document.createElement("div");
      item.className = "item";
      item.innerText = `${data.concepto || data.descripcion || "(sin nombre)"} ‚Äî $${data.precioPublico ?? 0}`;
      item.onclick = () => {
        seleccionarProducto(data);
        cerrarModal();
      };
      lista.appendChild(item);
    });

    const totalPags = Math.max(1, Math.ceil(resultadosBusqueda.length / porPagina));
    document.getElementById("paginacion").innerText =
      `P√°gina ${paginaActual + 1} de ${totalPags}`;
  }

  function anteriorPagina() {
    if (paginaActual > 0) {
      paginaActual--;
      mostrarPagina();
    }
  }

  function siguientePagina() {
    const totalPags = Math.max(1, Math.ceil(resultadosBusqueda.length / porPagina));
    if (paginaActual < totalPags - 1) {
      paginaActual++;
      mostrarPagina();
    }
  }

  // ---------------- POR C√ìDIGO ----------------
  async function buscarPorCodigo() {
    const codigo = document.getElementById("buscador").value.trim();
    if (!codigo) return;

    const productos = await getAllProductos();
    let encontrado = productos.find(p => String(p.codigoBarra) === String(codigo));

    if (encontrado) {
      seleccionarProducto(encontrado);
    } else {
      document.getElementById("preview").innerText = "‚ùå No encontrado";
      document.getElementById("codigoSel").value = "";
      document.getElementById("conceptoSel").value = "";
      document.getElementById("precioSel").value = "";
    }
    document.getElementById("buscador").value = "";
  }

  function seleccionarProducto(data) {
    document.getElementById("codigoSel").value = data.codigoBarra;
    document.getElementById("conceptoSel").value = data.concepto || data.descripcion || "";
    document.getElementById("precioSel").value = data.precioPublico ?? 0;
    document.getElementById("preview").innerText =
      `${data.concepto || data.descripcion} ‚Äî $${data.precioPublico}`;

    const cantidadInput = document.getElementById("cantidad");
    cantidadInput.focus();
    cantidadInput.select();
  }

  function agregarItem() {
    const codigo = document.getElementById("codigoSel").value;
    const concepto = document.getElementById("conceptoSel").value;
    const precio = parseFloat(document.getElementById("precioSel").value || "0");
    let cantidad = parseInt(document.getElementById("cantidad").value || "1", 10);

    if (!codigo) return;
    if (!cantidad || cantidad < 1) cantidad = 1;

    carrito.push({ codigo, concepto, precio, cantidad });
    renderTabla();

    document.getElementById("cantidad").value = "1";
    document.getElementById("preview").innerText = "";
    document.getElementById("codigoSel").value = "";
    document.getElementById("conceptoSel").value = "";
    document.getElementById("precioSel").value = "";
    document.getElementById("buscador").focus();
  }

  function renderTabla() {
    const tabla = document.getElementById("tabla");
    tabla.innerHTML = "";

    if (carrito.length === 0) {
      tabla.innerHTML = `<tr><td colspan="5">No hay productos agregados</td></tr>`;
      return;
    }

    carrito.forEach((item, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.codigo}</td>
        <td>${item.concepto}</td>
        <td>${item.cantidad}</td>
        <td>$${item.precio.toFixed(2)}</td>
        <td><button onclick="eliminarItem(${i})">‚ùå</button></td>
      `;
      tabla.appendChild(row);
    });
  }

  function eliminarItem(index) {
    carrito.splice(index, 1);
    renderTabla();
  }

  // ---------------- FINALIZAR TRASPASO ----------------
  async function finalizarTraspaso() {
    const ruta = document.getElementById("ruta").value;
    const vendedor = document.getElementById("vendedor").value || "No asignado";
    if (carrito.length === 0 || !ruta) {
      alert("Faltan datos");
      return;
    }

    const folio = generarFolio(ruta);

    // Guardar en Firestore
    await addDoc(collection(db, `almacenes/${ruta}/entradas`), { folio, vendedor, items: carrito, createdAt: Timestamp.now() });
    await addDoc(collection(db, `almacenes/ALMACENCENTRALPDD/salidas`), { folio, vendedor, items: carrito, createdAt: Timestamp.now() });

    // Telegram
    await enviarTelegram(folio, ruta, vendedor, carrito);

    // Comprobante
    abrirComprobante(folio, ruta, vendedor, carrito);

    carrito = [];
    renderTabla();
  }

  function generarFolio(ruta) {
    const hoy = new Date();
    const dd = String(hoy.getDate()).padStart(2, "0");
    const mm = String(hoy.getMonth() + 1).padStart(2, "0");
    const yy = String(hoy.getFullYear()).slice(-2);
    const fecha = `${dd}${mm}${yy}`;
    const consecutivo = String(Math.floor(Math.random() * 999)).padStart(3, "0");
    return `${ruta}-${fecha}-${consecutivo}`;
  }

  function dividirEnBloques(array, size) {
    const bloques = [];
    for (let i = 0; i < array.length; i += size) {
      bloques.push(array.slice(i, i + size));
    }
    return bloques;
  }

  async function enviarTelegram(folio, destino, vendedor, items) {
    const total = items.length;
    const bloques = dividirEnBloques(items, 20);

    for (let i = 0; i < bloques.length; i++) {
      let mensaje = `üì¶ *Nuevo Traspaso*\n`;
      if (i === 0){
        mensaje += `Folio: ${folio}\nDestino: ${destino}\nVendedor: ${vendedor}\nTotal de productos: ${total}\n`;
      }
      mensaje += `üìã *Bloque ${i+1}/${bloques.length}:*\n`;
      bloques[i].forEach(it=>{
        mensaje += `- ${it.cantidad} x ${it.concepto}\n`;
      });

      await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: CHAT_ID, text: mensaje, parse_mode: "Markdown" })
      });
    }
  }

  function abrirComprobante(folio, ruta, vendedor, items) {
    const fecha = new Date().toLocaleDateString();
    let tabla = "";
    items.forEach(it=>{
      tabla += `<tr><td>${it.codigo}</td><td>${it.concepto}</td><td>${it.cantidad}</td><td>$${it.precio.toFixed(2)}</td></tr>`;
    });

    const win = window.open("", "_blank");
    win.document.write(`
      <html><head><title>Comprobante ${folio}</title>
      <style>
        body{font-family:'Poppins',sans-serif;margin:20px;}
        h1{text-align:center;color:#003366;}
        .folio{font-size:20px;font-weight:bold;color:#b30000;text-align:center;border:2px dashed #b30000;margin:10px;padding:5px;}
        table{width:100%;border-collapse:collapse;margin-top:15px;}
        th,td{border:1px solid #ccc;padding:6px;text-align:center;}
        th{background:#00416A;color:white;}
        .firmas{margin-top:40px;display:flex;justify-content:space-between;}
        .firma{width:45%;text-align:center;}
        .linea{margin-top:60px;border-top:1px solid #000;}
      </style></head><body>
      <h1>üì¶ PROVEEDORA DE DULCES Y DESECHABLES</h1>
      <h2 style="text-align:center">Comprobante de Traspaso</h2>
      <div class="folio">Folio: ${folio}</div>
      <p><b>Fecha:</b> ${fecha}<br><b>Destino:</b> ${ruta}<br><b>Vendedor:</b> ${vendedor}<br><b>Total de partidas:</b> ${items.length}</p>
      <table><thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th></tr></thead><tbody>
      ${tabla}
      </tbody></table>
      <div class="firmas">
        <div class="firma"><div class="linea"></div>Entreg√≥ (Administrador)</div>
        <div class="firma"><div class="linea"></div>Recibi√≥ (Vendedor)</div>
      </div>
      <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
      </body></html>
    `);
    win.document.close();
  }

  function cerrarModal(){
    document.getElementById("modalResultados").style.display = "none";
  }

  // ---------------- INIT ----------------
  document.addEventListener("DOMContentLoaded", async ()=>{
    await syncProductos();
    document.getElementById("buscador").focus();

    document.getElementById("btnBuscarCodigo").addEventListener("click", buscarPorCodigo);
    document.getElementById("btnBuscarNombre").addEventListener("click", () => {
      document.getElementById("modalResultados").style.display = "block";
      document.getElementById("busquedaNombre").focus();
      buscarPorNombre();
    });
    document.getElementById("busquedaNombre").addEventListener("input", buscarPorNombre);
    document.getElementById("cerrarModal").addEventListener("click", cerrarModal);
    document.getElementById("btnAnterior").addEventListener("click", anteriorPagina);
    document.getElementById("btnSiguiente").addEventListener("click", siguientePagina);
    document.getElementById("btnAgregar").addEventListener("click", agregarItem);
    document.getElementById("btnTraspaso").addEventListener("click", finalizarTraspaso);

    window.eliminarItem = eliminarItem;
  });
</script>
  <style>
    :root {
      --azul:#00416A;
      --resalte:#0c6cbd;
      --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9);
      --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px;
    }

    body {
      font-family:'Poppins',sans-serif;
      margin:0;
      background:var(--bg-grad);
      min-height:100vh;
      color:white;
    }

    .panel {
      max-width:900px;
      margin:30px auto;
      background:var(--card);
      color:#222;
      padding:20px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:relative;
      z-index:1;
    }

    h2 { color: var(--azul); margin-top:0; }

    label { display:block; margin-top:10px; font-weight:600; }
    input,select { padding:8px; border:1px solid #ccc; border-radius:6px; }
    #buscador { width:70%; }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }
    th,td {
      border:1px solid #ccc;
      padding:8px;
      text-align:center;
    }
    th { background: var(--azul); color:white; }

    .btn {
      background:var(--resalte);
      color:white;
      font-weight:600;
      padding:10px 16px;
      border:none;
      border-radius:10px;
      cursor:pointer;
    }
    .btn:hover { background:#084f92; }

    .modal {
      display:none; position:fixed; z-index:1000;
      left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5);
    }
    .modal-content {
      background:#fff;
      margin:5% auto;
      padding:20px;
      border-radius:10px;
      width:80%; max-width:600px; max-height:70%;
      overflow-y:auto;
    }
    .close { float:right; font-size:28px; cursor:pointer; }
    #listaResultados .item { padding:8px; border-bottom:1px solid #eee; cursor:pointer; }
    #listaResultados .item:hover { background:#f0f0f0; }
    .footer { text-align:center; margin-top:20px; font-size:14px; color:#eee; }

    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px 30px; }
    .buscador-group,.cantidad-group { display:flex; gap:8px; align-items:center; }
    .buscador-group input { flex:1; }
    .cantidad-group input { width:80px; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>‚¨áÔ∏è Traspaso a Vendedores</h2>

    <div class="form-grid">
      <div>
        <label>Ruta destino:</label>
        <select id="ruta">
          <option value="">-- Seleccionar --</option>
          <option value="Almacen_Ruta_1">Ruta 1</option>
          <option value="Almacen_Ruta_2">Ruta 2</option>
        </select>
      </div>

      <div>
        <label>Vendedor:</label>
        <input type="text" id="vendedor" readonly />
      </div>

      <div>
        <label>Captura producto:</label>
        <div class="buscador-group">
          <input type="text" id="buscador" placeholder="Escanea c√≥digo de barras..." />
          <button id="btnBuscarCodigo">‚úîÔ∏è Capturar</button>
          <button id="btnBuscarNombre">üîç Buscar</button>
        </div>
        <div id="preview" style="margin:10px 0;font-weight:bold;color:#003366;"></div>
        <input type="hidden" id="codigoSel">
        <input type="hidden" id="conceptoSel">
        <input type="hidden" id="precioSel">
      </div>

      <div>
        <label>Cantidad:</label>
        <div class="cantidad-group">
          <input type="number" id="cantidad" value="1" min="1"/>
          <button class="btn" id="btnAgregar">‚ûï Agregar a Lista</button>
        </div>
      </div>
    </div>

    <table>
      <thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th><th></th></tr></thead>
      <tbody id="tabla"></tbody>
    </table>
    <button class="btn" id="btnTraspaso">üì§ Finalizar Traspaso</button>
  </div>

  <!-- Modal resultados -->
  <div id="modalResultados" class="modal">
    <div class="modal-content">
      <span id="cerrarModal" class="close">&times;</span>
      <h3>Resultados de b√∫squeda</h3>
      <input type="text" id="busquedaNombre" placeholder="Escribe nombre..." style="width:100%;margin-bottom:10px;">
      <div id="listaResultados"></div>
      <div style="margin-top:10px;text-align:center;">
        <button id="btnAnterior">‚¨ÖÔ∏è Anterior</button>
        <span id="paginacion"></span>
        <button id="btnSiguiente">Siguiente ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <div class="footer">Powered by <b>PROVSOFT</b></div>
</body>
</html>
